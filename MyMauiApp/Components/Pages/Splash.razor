@page "/"
@page "/splash"

@implements IDisposable
@using System.Linq
@using MyMauiApp.Services

@inject IPinService PinService
@inject AppLockState LockState
@inject NavigationManager Nav

<style>
    :root {
        --primary: #f97316;
        --primary2: #fb923c;
        --text: #ffffff;
        --muted: rgba(255,255,255,.72);
        --border: rgba(255,255,255,.18);
        --shadow: 0 24px 70px rgba(0,0,0,.45);
        --radius: 18px;
    }
    .splash-overlay {
        position: fixed;
        inset: 0;
        z-index: 999999;
        display: grid;
        place-items: center;
        padding: 24px;
        overflow: hidden;
        background-image: linear-gradient(180deg, rgba(8,10,18,.75), rgba(8,10,18,.85)), url('images/splash-bg.png');
        background-size: cover;
        background-position: center;
    }

    .bg-greeting-wrap {
        position: absolute;
        top: 7%;
        left: 0;
        right: 0;
        text-align: center;
        pointer-events: none;
        z-index: 0;
        padding: 0 16px;
    }

    .bg-greeting {
        font-size: clamp(56px, 7vw, 120px);
        font-weight: 1000;
        letter-spacing: 2px;
        line-height: 1.05;
        color: #ffffff;
        text-shadow: 0 0 12px rgba(255,255,255,.55), 0 24px 70px rgba(0,0,0,.7);
    }

    .bg-quote {
        margin-top: 10px;
        font-size: clamp(14px, 1.6vw, 18px);
        font-weight: 700;
        font-style: italic;
        color: rgba(255,255,255,.82);
        text-shadow: 0 0 10px rgba(0,0,0,.55);
        max-width: 980px;
        margin-left: auto;
        margin-right: auto;
        line-height: 1.35;
        opacity: 0.98;
    }

    .card {
        width: 100%;
        max-width: 520px;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        background: rgba(255,255,255,.10);
        box-shadow: var(--shadow);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        padding: 20px;
        position: relative;
        z-index: 1;
    }

    .security-head {
        display: flex;
        gap: 12px;
        align-items: center;
        padding: 12px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,.16);
        background: rgba(255,255,255,.06);
    }

    .security-icon {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        display: grid;
        place-items: center;
        background: rgba(34,197,94,.14);
        border: 1px solid rgba(34,197,94,.25);
        font-size: 20px;
    }

    .security-title {
        margin: 0;
        font-size: 14px;
        font-weight: 950;
        color: var(--text);
    }
    .security-sub {
        margin: 2px 0 0;
        font-size: 12px;
        font-weight: 750;
        color: var(--muted);
    }
    .pin-input {
        width: 100%;
        height: 56px;
        margin-top: 14px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,.20);
        outline: none;
        background: linear-gradient(rgba(255,255,255,.08), rgba(255,255,255,.06)), repeating-linear-gradient( to right, rgba(255,255,255,.18) 0, rgba(255,255,255,.18) 1px, transparent 1px, transparent calc(25% - 1px) );
        color: var(--text);
        font-weight: 950;
        font-size: 18px;
        text-align: center;
        letter-spacing: 18px;
    }

    .row {
        display: flex;
        gap: 10px;
        margin-top: 12px;
    }

    .btn {
        flex: 1;
        padding: 12px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,.18);
        background: linear-gradient(180deg, var(--primary2), var(--primary));
        color: #fff;
        font-weight: 950;
        cursor: pointer;
    }

    .btn-ghost {
        background: rgba(255,255,255,.08);
        color: var(--text);
    }

    .msg {
        margin-top: 12px;
        padding: 10px 12px;
        border-radius: 14px;
        font-size: 13px;
        font-weight: 850;
        background: rgba(239,68,68,.16);
        border: 1px solid rgba(239,68,68,.25);
        color: #fff;
        white-space: pre-wrap;
    }

    .ok {
        background: rgba(34,197,94,.16);
        border-color: rgba(34,197,94,.28);
    }
</style>

<div class="splash-overlay">

    <!--Background ma quots run garauni-->
    <div class="bg-greeting-wrap">
        <div class="bg-greeting">@Greeting</div>
        <div class="bg-quote">“@CurrentQuote”</div>
    </div>

    <div class="card">
        @if (isChecking)
        {
            <div class="security-head">
                <div class="security-icon"></div>
                <div>
                    <p class="security-title">Checking security</p>
                    <p class="security-sub">Loading…</p>
                </div>
            </div>
        }
        else if (!pinEnabled)
        {
            <div class="security-head">
                <div class="security-icon"></div>
                <div>
                    <p class="security-title">Security ready</p>
                    <p class="security-sub">No PIN is enabled</p>
                </div>
            </div>

            <div class="row">
                <button class="btn" @onclick="EnterApp">Enter</button>
            </div>
        }
        else
        {
            <div class="security-head">
                <div class="security-icon">🔐</div>
                <div>
                    <p class="security-title">Confirm your security</p>
                    <p class="security-sub">Please enter the 4 digit code</p>
                </div>
            </div>

            <input class="pin-input"
                   inputmode="numeric"
                   maxlength="4"
                   placeholder="● ● ● ●"
                   @bind="pin"
                   @bind:event="oninput" />

            <div class="row">
                <button class="btn" @onclick="TryUnlock">Confirm</button>
                <button class="btn btn-ghost" @onclick="Clear">Clear</button>
            </div>
        }

        @if (!string.IsNullOrWhiteSpace(message))
        {
            <div class="msg @(messageOk ? "ok" : "")">@message</div>
        }
    </div>
</div>

@code {
    private bool isChecking = true;
    private bool pinEnabled;
    private string pin = "";
    private string message = "";
    private bool messageOk;

    private string Greeting => GetGreeting();

    // mero quots  list rakhako xu yeha  
    private readonly string[] _quotes = new[]
    {
        "Discipline is choosing what you want most over what you want now. — Abraham Lincoln",
        "We are what we repeatedly do. Excellence, then, is not an act, but a habit. — Aristotle",
        "It always seems impossible until it’s done. — Nelson Mandela",
        "Do not wait for the perfect moment. Take the moment and make it perfect. — Zoey Sayward",
        "Small steps every day lead to big results. — Biduth",
        "Your future is created by what you do today, not tomorrow. — Robert Kiyosaki",
        "Courage doesn’t mean you don’t feel fear. It means you don’t let fear stop you. — Joyce Meyer ",
        "If you get tired, learn to rest, not to quit. — Banksy",
        "What you practice grows stronger. — Shauna Shapiro",
        "Be so good they can’t ignore you. — Steve Martin"
    };

    private int _quoteIndex = 0;
    private System.Threading.PeriodicTimer? _quoteTimer;
    private CancellationTokenSource? _quoteCts;

    private string CurrentQuote => _quotes[_quoteIndex];

    protected override async Task OnInitializedAsync()
    {
        LockState.Lock();

        StartQuoteRotation(); 

        try
        {
            pinEnabled = await PinService.IsPinEnabledAsync();
        }
        finally
        {
            isChecking = false;
        }
    }

    private void StartQuoteRotation()
    {
        _quoteCts?.Cancel();
        _quoteCts?.Dispose();

        _quoteCts = new CancellationTokenSource();
        _quoteTimer = new System.Threading.PeriodicTimer(TimeSpan.FromSeconds(5));

        _ = Task.Run(async () =>
        {
            try
            {
                while (await _quoteTimer.WaitForNextTickAsync(_quoteCts.Token))
                {
                    _quoteIndex = (_quoteIndex + 1) % _quotes.Length;
                    await InvokeAsync(StateHasChanged);
                }
            }
            catch (OperationCanceledException) { }
        });
    }

    private async Task TryUnlock()
    {
        message = "";
        messageOk = false;

        if (pin.Length != 4 || !pin.All(char.IsDigit))
        {
            message = "PIN must be 4 digits.";
            return;
        }

        var ok = await PinService.VerifyPinAsync(pin);
        if (!ok)
        {
            message = "Wrong PIN. Try again.";
            pin = "";
            return;
        }

        LockState.Unlock();
        messageOk = true;
        message = "Unlocked ✓";
        Nav.NavigateTo("/dashboard", true);
    }

    private void EnterApp()
    {
        LockState.Unlock();
        Nav.NavigateTo("/dashboard", true);
    }

    private void Clear()
    {
        pin = "";
        message = "";
        messageOk = false;
    }

    private static string GetGreeting()
    {
        var h = DateTime.Now.Hour;
        if (h < 12) return "Good Morning ☀️";
        if (h < 17) return "Good Afternoon 🌤️";
        return "Good Evening 🌙";
    }

    public void Dispose()
    {
        try
        {
            _quoteCts?.Cancel();
            _quoteTimer?.Dispose();
            _quoteCts?.Dispose();
        }
        catch { }
    }
}
