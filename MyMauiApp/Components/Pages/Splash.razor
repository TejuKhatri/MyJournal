@page "/"
@page "/splash"

@using System.Linq
@using MyMauiApp.Services

@inject IPinService PinService
@inject AppLockState LockState
@inject NavigationManager Nav

<style>
    :root {
        --primary: #f97316;
        --primary2: #fb923c;
        --text: #ffffff;
        --muted: rgba(255,255,255,.72);
        --border: rgba(255,255,255,.18);
        --shadow: 0 24px 70px rgba(0,0,0,.45);
        --radius: 18px;
    }

    /* ===== FULL SCREEN OVERLAY (covers nav) ===== */
    .splash-overlay {
        position: fixed;
        inset: 0;
        z-index: 999999;
        display: grid;
        place-items: center;
        padding: 24px;
        overflow: hidden;
        background-image: linear-gradient(180deg, rgba(8,10,18,.75), rgba(8,10,18,.85)), url('images/splash-bg.png');
        background-size: cover;
        background-position: center;
    }

    /* ===== BIG GREETING ON BACKGROUND (TOP AREA) ===== */
    .bg-greeting {
        position: absolute;
        top: 8%;
        left: 0;
        right: 0;
        text-align: center;
        pointer-events: none;
        z-index: 0;
        font-size: clamp(56px, 7vw, 120px);
        font-weight: 1000;
        letter-spacing: 2px;
        line-height: 1.05;
        color: #ffffff;
        text-shadow: 0 0 12px rgba(255,255,255,.55), 0 24px 70px rgba(0,0,0,.7);
    }

    /* ===== GLASS CARD ===== */
    .card {
        width: 100%;
        max-width: 520px;
        border-radius: var(--radius);
        border: 1px solid var(--border);
        background: rgba(255,255,255,.10);
        box-shadow: var(--shadow);
        backdrop-filter: blur(16px);
        -webkit-backdrop-filter: blur(16px);
        padding: 20px;
        position: relative;
        z-index: 1;
    }

    /* ===== SECURITY HEADER (NO GREETING HERE) ===== */
    .security-head {
        display: flex;
        gap: 12px;
        align-items: center;
        padding: 12px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,.16);
        background: rgba(255,255,255,.06);
    }

    .security-icon {
        width: 44px;
        height: 44px;
        border-radius: 14px;
        display: grid;
        place-items: center;
        background: rgba(34,197,94,.14);
        border: 1px solid rgba(34,197,94,.25);
        font-size: 20px;
    }

    .security-title {
        margin: 0;
        font-size: 14px;
        font-weight: 950;
        color: var(--text);
    }

    .security-sub {
        margin: 2px 0 0;
        font-size: 12px;
        font-weight: 750;
        color: var(--muted);
    }

    /* ===== PIN INPUT ===== */
    .pin-input {
        width: 100%;
        height: 56px;
        margin-top: 14px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,.20);
        outline: none;
        background: linear-gradient(rgba(255,255,255,.08), rgba(255,255,255,.06)), repeating-linear-gradient( to right, rgba(255,255,255,.18) 0, rgba(255,255,255,.18) 1px, transparent 1px, transparent calc(25% - 1px) );
        color: var(--text);
        font-weight: 950;
        font-size: 18px;
        text-align: center;
        letter-spacing: 18px;
    }

    .row {
        display: flex;
        gap: 10px;
        margin-top: 12px;
    }

    .btn {
        flex: 1;
        padding: 12px;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,.18);
        background: linear-gradient(180deg, var(--primary2), var(--primary));
        color: #fff;
        font-weight: 950;
        cursor: pointer;
    }

    .btn-ghost {
        background: rgba(255,255,255,.08);
        color: var(--text);
    }

    .hint {
        margin-top: 10px;
        text-align: center;
        font-size: 12px;
        font-weight: 750;
        color: rgba(255,255,255,.65);
    }

    .msg {
        margin-top: 12px;
        padding: 10px 12px;
        border-radius: 14px;
        font-size: 13px;
        font-weight: 850;
        background: rgba(239,68,68,.16);
        border: 1px solid rgba(239,68,68,.25);
        color: #fff;
        white-space: pre-wrap;
    }

    .ok {
        background: rgba(34,197,94,.16);
        border-color: rgba(34,197,94,.28);
    }
</style>

<div class="splash-overlay">

    <!-- ✅ Greeting ONLY on background -->
    <div class="bg-greeting">@Greeting</div>

    <div class="card">
        @if (isChecking)
        {
            <div class="security-head">
                <div class="security-icon"></div>
                <div>
                    <p class="security-title">Checking security</p>
                    <p class="security-sub">Loading…</p>
                </div>
            </div>
        }
        else if (!pinEnabled)
        {
            <div class="security-head">
                <div class="security-icon"></div>
                <div>
                    <p class="security-title">Security ready</p>
                    <p class="security-sub">No PIN is enabled</p>
                </div>
            </div>

            <div class="row">
                <button class="btn" @onclick="EnterApp">Enter</button>
            </div>
        }
        else
        {
            <div class="security-head">
                <div class="security-icon">🔐</div>
                <div>
                    <p class="security-title">Confirm your security</p>
                    <p class="security-sub">Please enter the 4 digit code</p>
                </div>
            </div>

            <input class="pin-input"
                   inputmode="numeric"
                   maxlength="4"
                   placeholder="● ● ● ●"
                   @bind="pin"
                   @bind:event="oninput" />

            <div class="row">
                <button class="btn" @onclick="TryUnlock">Confirm</button>
                <button class="btn btn-ghost" @onclick="Clear">Clear</button>
            </div>

            
        }

        @if (!string.IsNullOrWhiteSpace(message))
        {
            <div class="msg @(messageOk ? "ok" : "")">@message</div>
        }
    </div>
</div>

@code {
    private bool isChecking = true;
    private bool pinEnabled;
    private string pin = "";
    private string message = "";
    private bool messageOk;

    private string Greeting => GetGreeting();

    protected override async Task OnInitializedAsync()
    {
        LockState.Lock();
        try
        {
            pinEnabled = await PinService.IsPinEnabledAsync();
        }
        finally
        {
            isChecking = false;
        }
    }

    private async Task TryUnlock()
    {
        message = "";
        messageOk = false;

        if (pin.Length != 4 || !pin.All(char.IsDigit))
        {
            message = "PIN must be 4 digits.";
            return;
        }

        var ok = await PinService.VerifyPinAsync(pin);
        if (!ok)
        {
            message = "Wrong PIN. Try again.";
            pin = "";
            return;
        }

        LockState.Unlock();
        messageOk = true;
        message = "Unlocked ✓";
        Nav.NavigateTo("/dashboard", true);
    }

    private void EnterApp()
    {
        LockState.Unlock();
        Nav.NavigateTo("/dashboard", true);
    }

    private void Clear()
    {
        pin = "";
        message = "";
        messageOk = false;
    }

    private static string GetGreeting()
    {
        var h = DateTime.Now.Hour;
        if (h < 12) return "Good Morning";
        if (h < 17) return "Good Afternoon";
        return "Good Evening";
    }
}
